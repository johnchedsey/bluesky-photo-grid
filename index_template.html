<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>{{ WEBSITE_TITLE }}</title>
  <link rel="alternate" type="application/rss+xml" title="{{ WEBSITE_TITLE }} RSS" href="feed.xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery.min.css">
  <link rel="stylesheet" href="style.css">
  <style>
    .controls-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .sort-control {
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .sort-control label {
      font-size: 16px;
      color: #ddd;
      user-select: none;
    }
    .sort-control select {
      padding: 8px 12px;
      background: linear-gradient(to bottom, #444, #333);
      border: none;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
      font-size: 16px;
      min-width: 150px;
    }
    .sort-control select:hover {
      background: linear-gradient(to bottom, #555, #444);
      transform: translateY(-1px);
    }
    .sort-control select:focus {
      outline: 2px solid #666;
      outline-offset: 2px;
    }
    .sort-control select option {
      background: #333;
      color: #fff;
    }
  </style>
</head>
<body>
  <h1 data-cy="website-title">{{ WEBSITE_TITLE }}</h1>
  <h3 class="subtitle" data-cy="website-subtitle">{{ WEBSITE_SUBTITLE }}</h3>
  <hr class="modern-hr">

  <div class="controls-wrapper">
    <div class="sort-control">
      <label for="sort-select">Sort by:</label>
      <select id="sort-select" aria-label="Sort images" data-cy="sort-select">
        <option value="date-desc">Newest First</option>
        <option value="date-asc">Oldest First</option>
        <option value="likes-desc">Most Likes</option>
        <option value="likes-asc">Least Likes</option>
        <option value="reposts-desc">Most Reposts</option>
        <option value="replies-desc">Most Replies</option>
      </select>
    </div>
  </div>

  <div id="lightgallery" class="grid" data-cy="gallery-grid"></div>

  <div class="pagination">
    <button id="prev-btn" data-cy="prev-button">Previous</button>
    <select id="page-select" aria-label="Jump to page" data-cy="page-select"></select>
    <button id="next-btn" data-cy="next-button">Next</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.min.js"></script>
  <script>
    const useHighResTile = {{ 'true' if config.output.highres_tile else 'false' }};
    const gallery = document.getElementById('lightgallery');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageSelect = document.getElementById('page-select');
    const sortSelect = document.getElementById('sort-select');

    let lg = null;
    let allImages = [];
    let images = [];
    const pageSize = 25;
    let currentPageImages = [];
    let initialLoad = true;

    function getPageFromURL() {
      const params = new URLSearchParams(window.location.search);
      const page = parseInt(params.get('page'));
      return (!isNaN(page) && page > 0) ? page : 1;
    }

    function getSortFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('sort') || 'date-desc';
    }

    function setURLParams(page, sort) {
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      params.set('sort', sort);
      const newUrl = location.pathname + '?' + params.toString() + location.hash;
      window.history.pushState({page, sort}, '', newUrl);
    }

    function sortImages(sortBy) {
      const sorted = [...allImages];
      
      switch(sortBy) {
        case 'date-desc':
          sorted.sort((a, b) => b.date.localeCompare(a.date));
          break;
        case 'date-asc':
          sorted.sort((a, b) => a.date.localeCompare(b.date));
          break;
        case 'likes-desc':
          sorted.sort((a, b) => b.likes - a.likes);
          break;
        case 'likes-asc':
          sorted.sort((a, b) => a.likes - b.likes);
          break;
        case 'reposts-desc':
          sorted.sort((a, b) => b.reposts - a.reposts);
          break;
        case 'replies-desc':
          sorted.sort((a, b) => b.replies - a.replies);
          break;
      }
      
      return sorted;
    }

    function populatePageSelect(totalPages, currentPage) {
      pageSelect.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Page ${i} of ${totalPages}`;
        if (i === currentPage) {
          option.selected = true;
        }
        pageSelect.appendChild(option);
      }
    }

    async function loadImages() {
      const response = await fetch('data/images.json');
      if (!response.ok) {
        console.error("Failed to load images.json");
        return;
      }
      allImages = await response.json();
      
      const sortBy = getSortFromURL();
      sortSelect.value = sortBy;
      images = sortImages(sortBy);
      
      renderPage(getPageFromURL());
      if (initialLoad) {
        initialLoad = false;
        setTimeout(openGalleryFromAnchor, 0);
      }
    }

    function renderPage(page, updateHistory = true) {
      gallery.innerHTML = '';
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      currentPageImages = images.slice(start, end);

      currentPageImages.forEach((img, idx) => {
        const anchor = document.createElement('a');
        anchor.href = img.src;
        anchor.dataset.index = idx;
        anchor.dataset.cy = idx === 0 ? 'first-grid-item' : `grid-item-${idx}`;
        anchor.dataset.subHtml = `
          <div class='lg-sub-html'>
            <span class='description'>${img.description}</span><br>
            <span class='post-info'>Posted on ${img.date} | ‚ù§Ô∏è ${img.likes} | üîÑ ${img.reposts} | üí¨ ${img.replies}
            <a href='${img.link}' target='_blank'>View it on Bluesky</a></span>
          </div>`;
        anchor.innerHTML = `<img src="${useHighResTile ? img.src : img.thumb}" loading="lazy">`;
        gallery.appendChild(anchor);
      });

      if (lg) lg.destroy();
      lg = lightGallery(gallery, { selector: 'a', download: false, counter: false });

      gallery.addEventListener('lgAfterOpen', (event) => {
        if(event.detail){
          const idx = event.detail.index;
          const imgId = currentPageImages[idx].id;
          history.replaceState(null, '', location.pathname + location.search + `#img-${encodeURIComponent(imgId)}`);
        }
      });

      gallery.addEventListener('lgAfterSlide', (event) => {
        const idx = event.detail.index;
        const imgId = currentPageImages[idx].id;
        history.replaceState(null, '', location.pathname + location.search + `#img-${encodeURIComponent(imgId)}`);
      });

      gallery.addEventListener('lgAfterClose', () => {
        history.replaceState(null, '', location.pathname + location.search);
      });

      updatePagination(page);
      window.scrollTo(0, 0);
      if (updateHistory) setURLParams(page, sortSelect.value);
    }

    async function openGalleryFromAnchor() {
      const hash = window.location.hash;
      if (hash.startsWith('#img-')) {
        const imgId = decodeURIComponent(hash.slice(5));
        const imgIndex = images.findIndex(img => img.id === imgId);
        if (imgIndex !== -1) {
          const targetPage = Math.floor(imgIndex / pageSize) + 1;
          const indexOnPage = imgIndex % pageSize;
          if (getPageFromURL() !== targetPage) {
            renderPage(targetPage, false);
          }
          await waitForGallery();
          lg.openGallery(indexOnPage);
        }
      }
    }

    function waitForGallery() {
      return new Promise((resolve) => {
        const checkGallery = setInterval(() => {
          if (lg && gallery.querySelector('a')) {
            clearInterval(checkGallery);
            resolve();
          }
        }, 100);
      });
    }

    function updatePagination(currentPage) {
      const totalPages = Math.ceil(images.length / pageSize);
      populatePageSelect(totalPages, currentPage);
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    prevBtn.onclick = () => renderPage(getPageFromURL() - 1);
    nextBtn.onclick = () => renderPage(getPageFromURL() + 1);
    pageSelect.onchange = () => renderPage(parseInt(pageSelect.value));
    
    sortSelect.onchange = () => {
      images = sortImages(sortSelect.value);
      renderPage(1);
    };

    window.onpopstate = () => {
      const sortBy = getSortFromURL();
      sortSelect.value = sortBy;
      images = sortImages(sortBy);
      renderPage(getPageFromURL(), false);
    };

    document.addEventListener('keydown', (e) => {
      if (lg && lg.lgOpened) return;
      if (e.key === 'ArrowLeft' && !prevBtn.disabled) prevBtn.click();
      else if (e.key === 'ArrowRight' && !nextBtn.disabled) nextBtn.click();
    });

    loadImages();
  </script>

  <hr class="modern-hr">
  <h3 class="footer">{{ WEBSITE_FOOTER }}</h3>
  <h3 class="footer">
    <a href="https://github.com/nkavassalis/bluesky-photo-grid">Powered by Bluesky Photo Grid</a>
  </h3>
</body>
</html>