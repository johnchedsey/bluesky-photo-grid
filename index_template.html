<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>{{ WEBSITE_TITLE }}</title>
  <link rel="alternate" type="application/rss+xml" title="{{ WEBSITE_TITLE }} RSS" href="feed.xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>{{ WEBSITE_TITLE }}</h1>
  <h3 class="subtitle">{{ WEBSITE_SUBTITLE }}</h3>
  <hr class="modern-hr">

  <div id="lightgallery" class="grid"></div>

  <div class="pagination">
    <button id="prev-btn">Previous</button>
    <span id="page-indicator"></span>
    <button id="next-btn">Next</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.min.js"></script>
  <script>
    const useHighResTile = {{ 'true' if config.output.highres_tile else 'false' }};
    const gallery = document.getElementById('lightgallery');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageIndicator = document.getElementById('page-indicator');

    let lg = null;
    let images = [];
    const pageSize = 25;
    let currentPageImages = [];
    let initialLoad = true;

    function getPageFromURL() {
      const params = new URLSearchParams(window.location.search);
      const page = parseInt(params.get('page'));
      return (!isNaN(page) && page > 0) ? page : 1;
    }

    function setPageInURL(page) {
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      const newUrl = location.pathname + '?' + params.toString() + location.hash;
      window.history.pushState({page}, '', newUrl);
    }

    async function loadImages() {
      const response = await fetch('data/images.json');
      if (!response.ok) {
        console.error("Failed to load images.json");
        return;
      }
      images = await response.json();
      renderPage(getPageFromURL());
      if (initialLoad) {
        initialLoad = false;
        setTimeout(openGalleryFromAnchor, 0);
      }
    }

    function renderPage(page, updateHistory = true) {
      gallery.innerHTML = '';
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      currentPageImages = images.slice(start, end);

      currentPageImages.forEach((img, idx) => {
        const anchor = document.createElement('a');
        anchor.href = img.src;
        anchor.dataset.index = idx;
        anchor.dataset.subHtml = `
          <div class='lg-sub-html'>
            <span class='description'>${img.description}</span><br>
            <span class='post-info'>Posted on ${img.date}
            <a href='${img.link}' target='_blank'>View it on Bluesky</a></span>
          </div>`;
        anchor.innerHTML = `<img src="${useHighResTile ? img.src : img.thumb}" loading="lazy">`;
        gallery.appendChild(anchor);
      });

      if (lg) lg.destroy();
      lg = lightGallery(gallery, { selector: 'a', download: false, counter: false });

      gallery.addEventListener('lgAfterOpen', (event) => {
        if(event.detail){
          const idx = event.detail.index;
          const imgId = currentPageImages[idx].id;
          history.replaceState(null, '', location.pathname + location.search + `#img-${encodeURIComponent(imgId)}`);
        }
      });

      gallery.addEventListener('lgAfterSlide', (event) => {
        const idx = event.detail.index;
        const imgId = currentPageImages[idx].id;
        history.replaceState(null, '', location.pathname + location.search + `#img-${encodeURIComponent(imgId)}`);
      });

      gallery.addEventListener('lgAfterClose', () => {
        history.replaceState(null, '', location.pathname + location.search);
      });

      updatePagination(page);
      window.scrollTo(0, 0);
      if (updateHistory) setPageInURL(page);
    }

    async function openGalleryFromAnchor() {
      const hash = window.location.hash;
      if (hash.startsWith('#img-')) {
        const imgId = decodeURIComponent(hash.slice(5));
        const imgIndex = images.findIndex(img => img.id === imgId);
        if (imgIndex !== -1) {
          const targetPage = Math.floor(imgIndex / pageSize) + 1;
          const indexOnPage = imgIndex % pageSize;
          if (getPageFromURL() !== targetPage) {
            renderPage(targetPage, false);
          }
          await waitForGallery();
          lg.openGallery(indexOnPage);
        }
      }
    }

    function waitForGallery() {
      return new Promise((resolve) => {
        const checkGallery = setInterval(() => {
          if (lg && gallery.querySelector('a')) {
            clearInterval(checkGallery);
            resolve();
          }
        }, 100);
      });
    }

    function updatePagination(currentPage) {
      const totalPages = Math.ceil(images.length / pageSize);
      pageIndicator.textContent = `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    prevBtn.onclick = () => renderPage(getPageFromURL() - 1);
    nextBtn.onclick = () => renderPage(getPageFromURL() + 1);

    window.onpopstate = () => renderPage(getPageFromURL(), false);

    document.addEventListener('keydown', (e) => {
      if (lg && lg.lgOpened) return;
      if (e.key === 'ArrowLeft' && !prevBtn.disabled) prevBtn.click();
      else if (e.key === 'ArrowRight' && !nextBtn.disabled) nextBtn.click();
    });

    loadImages();
  </script>

  <hr class="modern-hr">
  <h3 class="footer">{{ WEBSITE_FOOTER }}</h3>
  <h3 class="footer">
    <a href="https://github.com/nkavassalis/bluesky-photo-grid">Powered by Bluesky Photo Grid</a>
  </h3>
</body>
</html>

